<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave a Message</title>
  <style>
    /* (Your existing CSS unchanged) */
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;}
    .container {background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; max-width: 500px; width: 100%;}
    h1 {color: #333; margin-bottom: 10px; font-size: 28px;}
    .subtitle {color: #666; margin-bottom: 30px; font-size: 14px;}
    .last-message-card {background: #f8f9fa; border-left: 4px solid #667eea; padding: 12px 16px; margin-bottom: 20px; border-radius: 8px;}
    .last-message-header {font-size: 12px; font-weight: 600; color: #667eea; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;}
    .last-message-author {font-size: 14px; color: #333; font-weight: 500; margin-bottom: 4px;}
    .last-message-time {font-size: 12px; color: #666;}
    .last-message-loading {color: #999; font-size: 13px; font-style: italic;}
    .form-group {margin-bottom: 20px;}
    label {display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px;}
    .required-asterisk {color: #e74c3c; margin-left: 2px;}
    input, textarea {width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; transition: border-color 0.3s;}
    input:focus, textarea:focus {outline: none; border-color: #667eea;}
    input.error, textarea.error {border-color: #e74c3c;}
    textarea {resize: vertical; min-height: 120px;}
    button {width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;}
    button:hover:not(:disabled) {transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4);}
    button:active:not(:disabled) {transform: translateY(0);}
    button:disabled {opacity: 0.6; cursor: not-allowed; transform: none;}
    .message {margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-size: 14px; display: none;}
    .message.success {background: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
    .message.error {background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
    .message.warning {background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;}
    .message.show {display: block;}
    .char-count {text-align: right; font-size: 12px; color: #999; margin-top: 4px;}
    .debug {margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-size: 12px; font-family: monospace;}
    .validation {font-size: 12px; margin-top: 4px; display: none;}
    .validation.error {color: #e74c3c; display: block;}
    .validation.success {color: #27ae60; display: block;}
    .image-preview {margin-top: 10px; display: none; max-width: 100%; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
    .image-preview img {width: 100%; height: auto; display: block;}
    .image-preview.show {display: block;}
    .image-loading {display: none; text-align: center; padding: 10px; color: #666; font-size: 14px;}
    .image-loading.show {display: block;}
    .optional-label {color: #999; font-weight: normal;}
    .rate-limit-info {font-size: 12px; color: #666; margin-top: 8px; text-align: center;}
    .countdown {font-weight: bold; color: #e74c3c;}
    .plugin-source {color: #667eea; font-weight: 500;}
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ“¬ Leave a Message</h1>
  <p class="subtitle">Your message or image will appear on the TRMNL display</p>

  <div id="lastMessageCard" class="last-message-card" style="display: none;">
    <div class="last-message-header">Latest Message</div>
    <div id="lastMessageContent"></div>
  </div>

  <form id="messageForm">
    <div class="form-group">
      <label for="message">
        Message
        <span class="optional-label" id="messageOptionalLabel">(optional if sending an image)</span>
        <span class="required-asterisk" id="messageRequiredLabel" style="display: none;">*</span>
      </label>
      <textarea id="message" name="message" maxlength="280" placeholder="What's on your mind?"></textarea>
      <div class="char-count"><span id="charCount">0</span>/280</div>
    </div>

    <div class="form-group">
      <label for="author">
        Your Name
        <span class="optional-label" id="authorOptionalLabel">(optional)</span>
        <span class="required-asterisk" id="authorRequiredLabel" style="display: none;">*</span>
      </label>
      <input type="text" id="author" name="author" maxlength="50" placeholder="Leave blank for anonymous">
    </div>

    <div class="form-group">
      <label for="imageUrl">Image URL <span class="optional-label">(optional if sending a message)</span></label>
      <input type="url" id="imageUrl" name="imageUrl" placeholder="https://example.com/image.jpg">
      <div class="validation" id="imageValidation"></div>
      <div class="image-loading" id="imageLoading">Checking image...</div>
      <div class="image-preview" id="imagePreview"></div>
    </div>

    <button type="submit" id="submitBtn">Send Message</button>
    <div class="rate-limit-info" id="rateLimitInfo"></div>
  </form>

  <div id="statusMessage" class="message"></div>
  <div id="debugInfo" class="debug" style="display: none;"></div>
</div>

<script>
const form = document.getElementById('messageForm');
const messageInput = document.getElementById('message');
const authorInput = document.getElementById('author');
const imageUrlInput = document.getElementById('imageUrl');
const submitBtn = document.getElementById('submitBtn');
const statusMessage = document.getElementById('statusMessage');
const charCount = document.getElementById('charCount');
const debugInfo = document.getElementById('debugInfo');
const imageValidation = document.getElementById('imageValidation');
const imagePreview = document.getElementById('imagePreview');
const imageLoading = document.getElementById('imageLoading');
const rateLimitInfo = document.getElementById('rateLimitInfo');
const lastMessageCard = document.getElementById('lastMessageCard');
const lastMessageContent = document.getElementById('lastMessageContent');
const messageOptionalLabel = document.getElementById('messageOptionalLabel');
const messageRequiredLabel = document.getElementById('messageRequiredLabel');
const authorOptionalLabel = document.getElementById('authorOptionalLabel');
const authorRequiredLabel = document.getElementById('authorRequiredLabel');

const RATE_LIMIT_MINUTES = 5;
const RATE_LIMIT_MS = RATE_LIMIT_MINUTES * 60 * 1000;
const AUTHOR_STORAGE_KEY = 'message_author';
const PLUGIN_ID_STORAGE_KEY = 'plugin_id';
const CONFIG_STORAGE_KEY = 'plugin_config';
const MAX_TOTAL_SIZE = 2000;
const STREAM_LIMIT = 2;
const MAX_MESSAGE_LENGTH = 280;

const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

const urlParams = new URLSearchParams(window.location.search);
const encodedParam = urlParams.get('p') || urlParams.get('plugin') || urlParams.get('id');
const legacyWebhookParam = urlParams.get('webhook') || urlParams.get('url') || urlParams.get('plugin_id');

function base64UrlDecode(str) {
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while (str.length % 4) { str += '='; }
  try { return atob(str); } catch(e){ return null; }
}

function decodeConfig(encoded){
  try {
    const decoded = base64UrlDecode(encoded);
    if(!decoded) return null;
    const config = JSON.parse(decoded);
    if(!config.id || !UUID_REGEX.test(config.id)) return null;
    return { pluginId: config.id, authorRequired: config.ar===1||config.ar===true, messageRequired: config.mr===1||config.mr===true };
  } catch(e){ console.error('Failed decode config', e); return null; }
}

function extractPluginId(input){
  if(!input) return null;
  const urlMatch = input.match(/usetrmnl\.com\/api\/custom_plugins\/([0-9a-f-]{36})/i);
  if(urlMatch) return urlMatch[1];
  if(UUID_REGEX.test(input)) return input;
  return null;
}

function getPluginConfig(){
  let config=null, source='none';
  if(encodedParam){
    config=decodeConfig(encodedParam);
    if(config){
      source='url_encoded';
      localStorage.setItem(PLUGIN_ID_STORAGE_KEY, config.pluginId);
      localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(config));
    }
  }
  if(!config && legacyWebhookParam){
    const pluginId = extractPluginId(legacyWebhookParam);
    if(pluginId){
      config={pluginId, authorRequired:false, messageRequired:false};
      source='url_legacy';
      localStorage.setItem(PLUGIN_ID_STORAGE_KEY, pluginId);
      localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(config));
    }
  }
  if(!config){
    const storedConfig = localStorage.getItem(CONFIG_STORAGE_KEY);
    if(storedConfig){
      try{
        config = JSON.parse(storedConfig);
        if(!(config.pluginId && UUID_REGEX.test(config.pluginId))) config=null;
        else source='localStorage';
      } catch(e){
        const storedPluginId = localStorage.getItem(PLUGIN_ID_STORAGE_KEY);
        if(storedPluginId && UUID_REGEX.test(storedPluginId)) config={pluginId: storedPluginId, authorRequired:false, messageRequired:false}, source='localStorage';
      }
    }
  }
  return {config, source};
}

const {config, source} = getPluginConfig();

function getJsonSize(obj){ return new Blob([JSON.stringify(obj)]).size; }

async function fetchLastMessage(){
  if(!config||!config.pluginId) return null;
  try {
    const response = await fetch(`https://usetrmnl.com/api/custom_plugins/${config.pluginId}`);
    if(!response.ok) return null;
    const data = await response.json();
    if(data.merge_variables?.messages?.length) return data.merge_variables.messages[data.merge_variables.messages.length-1];
    return null;
  } catch(e){ console.error(e); return null; }
}

async function fetchAllMessages(){
  if(!config||!config.pluginId) return [];
  try{
    const response = await fetch(`https://usetrmnl.com/api/custom_plugins/${config.pluginId}`);
    if(!response.ok) return [];
    const data = await response.json();
    return Array.isArray(data.merge_variables?.messages)?data.merge_variables.messages:[];
  } catch(e){ console.error(e); return []; }
}

// === CLEAN MILLISECONDS PARSING ===
function parseTimestampWithoutMs(ts){ return new Date(ts.split('.')[0]+'Z'); }

function displayLastMessage(message){
  if(!message || !message.timestamp_utc){ lastMessageCard.style.display='none'; return; }
  const timestamp=parseTimestampWithoutMs(message.timestamp_utc);
  const localTime = timestamp.toLocaleString(undefined,{year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
  const author = message.author||'Anonymous';
  lastMessageContent.innerHTML=`<div class="last-message-author">${author}</div><div class="last-message-time">${localTime}</div>`;
  lastMessageCard.style.display='block';
}

function checkCanSendBasedOnLastMessage(lastMessage){
  if(!lastMessage || !lastMessage.timestamp_utc) return true;
  const lastTimestamp = parseTimestampWithoutMs(lastMessage.timestamp_utc).getTime();
  const now = Date.now();
  const timeSinceLast = now - lastTimestamp;
  if(timeSinceLast < RATE_LIMIT_MS){
    const remainingTime = RATE_LIMIT_MS - timeSinceLast;
    const remainingMinutes = Math.floor(remainingTime / (60*1000));
    const remainingSeconds = Math.ceil((remainingTime % (60*1000))/1000);
    submitBtn.disabled=true;
    rateLimitInfo.innerHTML=`Last message was sent too recently. Please wait <span class="countdown">${remainingMinutes}:${remainingSeconds.toString().padStart(2,'0')}</span>`;
    const countdownInterval = setInterval(()=>{
      const newRemainingTime = RATE_LIMIT_MS - (Date.now()-lastTimestamp);
      if(newRemainingTime <=0){ clearInterval(countdownInterval); submitBtn.disabled=false; rateLimitInfo.textContent=`You can send one message every ${RATE_LIMIT_MINUTES} minutes`; }
      else {
        const newRemainingMinutes = Math.floor(newRemainingTime / (60*1000));
        const newRemainingSeconds = Math.ceil((newRemainingTime % (60*1000))/1000);
        rateLimitInfo.innerHTML=`Last message was sent too recently. Please wait <span class="countdown">${newRemainingMinutes}:${newRemainingSeconds.toString().padStart(2,'0')}</span>`;
      }
    },1000);
    return false;
  }
  submitBtn.disabled=false;
  rateLimitInfo.textContent=`You can send one message every ${RATE_LIMIT_MINUTES} minutes`;
  return true;
}

// (Remaining JS logic unchanged, just replace new Date(...) with parseTimestampWithoutMs(...) wherever timestamps are used)

document.addEventListener('DOMContentLoaded', async ()=>{
  if(!config){ submitBtn.disabled=true; showMessage('âš  No configuration detected. Please scan the QR code to access this form.', 'error'); return; }

  if(config.authorRequired){ authorOptionalLabel.style.display='none'; authorRequiredLabel.style.display='inline'; authorInput.required=true; authorInput.placeholder='Your name is required'; }
  if(config.messageRequired){ messageOptionalLabel.style.display='none'; messageRequiredLabel.style.display='inline'; messageInput.required=true; messageInput.placeholder='Message is required'; messageInput.maxLength=MAX_MESSAGE_LENGTH; }

  charCount.textContent=`0/${MAX_MESSAGE_LENGTH}`;

  const savedAuthor=localStorage.getItem(AUTHOR_STORAGE_KEY);
  if(savedAuthor) authorInput.value=savedAuthor;

  lastMessageContent.innerHTML='<div class="last-message-loading">Loading last message...</div>';
  lastMessageCard.style.display='block';
  const lastMessage=await fetchLastMessage();
  displayLastMessage(lastMessage);
  checkCanSendBasedOnLastMessage(lastMessage);

  debugInfo.style.display='block';
  debugInfo.innerHTML=`Plugin ID: ${config.pluginId}<br>Source: ${source}<br>Author Required: ${config.authorRequired?'Yes':'No'}<br>Message Required: ${config.messageRequired?'Yes':'No'}<br>Max Message Length: ${MAX_MESSAGE_LENGTH}<br>Stream Limit: ${STREAM_LIMIT} messages<br>Max Total Size: ${MAX_TOTAL_SIZE} bytes`;
});
</script>
</body>
</html>
