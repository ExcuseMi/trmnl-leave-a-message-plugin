<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave a Message</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 500px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .message.show {
      display: block;
    }

    .char-count {
      text-align: right;
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    .debug {
      margin-top: 10px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
    }

    .validation {
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    .validation.error {
      color: #e74c3c;
      display: block;
    }

    .validation.success {
      color: #27ae60;
      display: block;
    }

    .image-preview {
      margin-top: 10px;
      display: none;
      max-width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .image-preview img {
      width: 100%;
      height: auto;
      display: block;
    }

    .image-preview.show {
      display: block;
    }

    .image-loading {
      display: none;
      text-align: center;
      padding: 10px;
      color: #666;
      font-size: 14px;
    }

    .image-loading.show {
      display: block;
    }

    .optional-label {
      color: #999;
      font-weight: normal;
    }

    .rate-limit-info {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }

    .countdown {
      font-weight: bold;
      color: #e74c3c;
    }

    .plugin-info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .plugin-source {
      color: #667eea;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“¬ Leave a Message</h1>
    <p class="subtitle">Your message or image will appear on the TRMNL display</p>

    <form id="messageForm">
      <div class="form-group">
        <label for="message">Message <span class="optional-label">(optional if sending an image)</span></label>
        <textarea
          id="message"
          name="message"
          maxlength="280"
          placeholder="What's on your mind?"></textarea>
        <div class="char-count"><span id="charCount">0</span>/280</div>
      </div>

      <div class="form-group">
        <label for="author">Your Name <span class="optional-label">(optional)</span></label>
        <input
          type="text"
          id="author"
          name="author"
          maxlength="50"
          placeholder="Leave blank for anonymous">
      </div>

      <div class="form-group">
        <label for="imageUrl">Image URL <span class="optional-label">(optional if sending a message)</span></label>
        <input
          type="url"
          id="imageUrl"
          name="imageUrl"
          placeholder="https://example.com/image.jpg">
        <div class="validation" id="imageValidation"></div>
        <div class="image-loading" id="imageLoading">Checking image...</div>
        <div class="image-preview" id="imagePreview"></div>
        <div style="font-size: 12px; color: #666; margin-top: 4px;">
          Add a link to an image to display with your message
        </div>
      </div>

      <button type="submit" id="submitBtn">Send Message</button>
      <div class="rate-limit-info" id="rateLimitInfo"></div>
    </form>

    <div id="statusMessage" class="message"></div>
    <div id="debugInfo" class="debug" style="display: none;"></div>
  </div>

  <script>
    const form = document.getElementById('messageForm');
    const messageInput = document.getElementById('message');
    const authorInput = document.getElementById('author');
    const imageUrlInput = document.getElementById('imageUrl');
    const submitBtn = document.getElementById('submitBtn');
    const statusMessage = document.getElementById('statusMessage');
    const charCount = document.getElementById('charCount');
    const debugInfo = document.getElementById('debugInfo');
    const imageValidation = document.getElementById('imageValidation');
    const imagePreview = document.getElementById('imagePreview');
    const imageLoading = document.getElementById('imageLoading');
    const rateLimitInfo = document.getElementById('rateLimitInfo');

    // Constants
    const RATE_LIMIT_MINUTES = 5;
    const RATE_LIMIT_MS = RATE_LIMIT_MINUTES * 60 * 1000;
    const AUTHOR_STORAGE_KEY = 'message_author';
    const LAST_SUBMISSION_KEY = 'last_message_submission';
    const PLUGIN_ID_STORAGE_KEY = 'plugin_id';

    // UUID validation regex
    const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

    // Get webhook URL from query parameter
    const urlParams = new URLSearchParams(window.location.search);
    let webhookParam = urlParams.get('webhook') || urlParams.get('url') || urlParams.get('plugin_id');

    // Extract plugin ID from full URL or validate UUID
    function extractPluginId(input) {
      if (!input) return null;

      // If it's a full TRMNL webhook URL, extract the UUID
      const urlMatch = input.match(/usetrmnl\.com\/api\/custom_plugins\/([0-9a-f-]{36})/i);
      if (urlMatch) {
        return urlMatch[1];
      }

      // If it looks like a UUID, use it directly
      if (UUID_REGEX.test(input)) {
        return input;
      }

      return null;
    }

    // Get plugin ID with fallback to localStorage
    function getPluginId() {
      let pluginId = null;
      let source = 'none';

      // First priority: URL parameter
      if (webhookParam) {
        pluginId = extractPluginId(webhookParam);
        if (pluginId) {
          source = 'url';
          // Save to localStorage when provided via URL
          localStorage.setItem(PLUGIN_ID_STORAGE_KEY, pluginId);
        }
      }

      // Second priority: localStorage
      if (!pluginId) {
        const storedPluginId = localStorage.getItem(PLUGIN_ID_STORAGE_KEY);
        if (storedPluginId && UUID_REGEX.test(storedPluginId)) {
          pluginId = storedPluginId;
          source = 'localStorage';
        }
      }

      return { pluginId, source };
    }

    const { pluginId, source } = getPluginId();

    // Initialize the form
    function initializeForm() {
      // Load saved author from localStorage
      const savedAuthor = localStorage.getItem(AUTHOR_STORAGE_KEY);
      if (savedAuthor) {
        authorInput.value = savedAuthor;
      }

      // Check rate limiting
      checkRateLimit();

      // Show debug info
      if (pluginId) {
        let sourceText = '';
        switch (source) {
          case 'url':
            sourceText = 'URL parameter (saved to localStorage)';
            break;
          case 'localStorage':
            sourceText = 'localStorage';
            break;
          default:
            sourceText = 'unknown';
        }

        debugInfo.innerHTML = `
          Plugin ID: ${pluginId}<br>
          Source: <span class="plugin-source">${sourceText}</span>
        `;
        debugInfo.style.display = 'block';
      }

      // Show validation error on page load
      if (!pluginId && webhookParam) {
        showMessage('âš  Invalid plugin ID or webhook URL format. Expected UUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx', 'error');
      } else if (!pluginId) {
        showMessage('âš  No webhook URL detected. Please scan the QR code to access this form.', 'error');
      } else if (source === 'localStorage') {
        showMessage('âœ“ Using saved plugin ID from previous session', 'success');
        setTimeout(() => {
          statusMessage.classList.remove('show');
        }, 3000);
      }
    }

    // Check rate limiting and update UI
    function checkRateLimit() {
      const lastSubmission = localStorage.getItem(LAST_SUBMISSION_KEY);

      if (!lastSubmission) {
        // No previous submission, allow sending
        submitBtn.disabled = false;
        rateLimitInfo.textContent = `You can send one message every ${RATE_LIMIT_MINUTES} minutes`;
        return true;
      }

      const timeSinceLastSubmission = Date.now() - parseInt(lastSubmission);

      if (timeSinceLastSubmission < RATE_LIMIT_MS) {
        // Rate limited - calculate remaining time
        const remainingTime = RATE_LIMIT_MS - timeSinceLastSubmission;
        const remainingMinutes = Math.ceil(remainingTime / (60 * 1000));
        const remainingSeconds = Math.ceil((remainingTime % (60 * 1000)) / 1000);

        submitBtn.disabled = true;
        rateLimitInfo.innerHTML = `Please wait <span class="countdown">${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}</span> before sending another message`;

        // Update countdown every second
        const countdownInterval = setInterval(() => {
          const newRemainingTime = RATE_LIMIT_MS - (Date.now() - parseInt(lastSubmission));

          if (newRemainingTime <= 0) {
            clearInterval(countdownInterval);
            submitBtn.disabled = false;
            rateLimitInfo.textContent = `You can send one message every ${RATE_LIMIT_MINUTES} minutes`;
          } else {
            const newRemainingMinutes = Math.floor(newRemainingTime / (60 * 1000));
            const newRemainingSeconds = Math.ceil((newRemainingTime % (60 * 1000)) / 1000);
            rateLimitInfo.innerHTML = `Please wait <span class="countdown">${newRemainingMinutes}:${newRemainingSeconds.toString().padStart(2, '0')}</span> before sending another message`;
          }
        }, 1000);

        return false;
      } else {
        // Rate limit expired, allow sending
        submitBtn.disabled = false;
        rateLimitInfo.textContent = `You can send one message every ${RATE_LIMIT_MINUTES} minutes`;
        return true;
      }
    }

    // Save last submission timestamp
    function saveLastSubmission() {
      localStorage.setItem(LAST_SUBMISSION_KEY, Date.now().toString());
    }

    // Character counter
    messageInput.addEventListener('input', () => {
      charCount.textContent = messageInput.value.length;
    });

    // Save author to localStorage when changed
    authorInput.addEventListener('input', () => {
      const authorValue = authorInput.value.trim();
      if (authorValue) {
        localStorage.setItem(AUTHOR_STORAGE_KEY, authorValue);
      } else {
        localStorage.removeItem(AUTHOR_STORAGE_KEY);
      }
    });

    // Image URL validation and preview
    let imageValidationTimeout;
    imageUrlInput.addEventListener('input', () => {
      clearTimeout(imageValidationTimeout);

      const url = imageUrlInput.value.trim();

      // Reset validation and preview
      imageValidation.className = 'validation';
      imagePreview.className = 'image-preview';
      imageLoading.className = 'image-loading';
      imagePreview.innerHTML = '';

      if (!url) {
        return;
      }

      // Basic URL validation
      try {
        new URL(url);
      } catch (e) {
        imageValidation.textContent = 'Please enter a valid URL';
        imageValidation.className = 'validation error';
        return;
      }

      // Check if URL points to an image
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
      const isImageUrl = imageExtensions.some(ext =>
        url.toLowerCase().includes(ext)
      );

      if (!isImageUrl) {
        imageValidation.textContent = 'URL does not appear to point to an image';
        imageValidation.className = 'validation error';
        return;
      }

      // Validate image by loading it
      imageValidationTimeout = setTimeout(() => {
        validateImageUrl(url);
      }, 500);
    });

    // Function to validate image URL by attempting to load it
    function validateImageUrl(url) {
      imageLoading.className = 'image-loading show';
      imagePreview.className = 'image-preview';

      const img = new Image();
      img.onload = function() {
        imageLoading.className = 'image-loading';
        imageValidation.textContent = 'âœ“ Valid image URL';
        imageValidation.className = 'validation success';

        // Show preview
        imagePreview.innerHTML = `<img src="${url}" alt="Image preview">`;
        imagePreview.className = 'image-preview show';
      };

      img.onerror = function() {
        imageLoading.className = 'image-loading';
        imageValidation.textContent = 'Image could not be loaded. Please check the URL.';
        imageValidation.className = 'validation error';
      };

      img.src = url;
    }

    // Show status message
    function showMessage(text, type) {
      statusMessage.textContent = text;
      statusMessage.className = `message ${type} show`;

      if (type === 'success') {
        setTimeout(() => {
          statusMessage.classList.remove('show');
        }, 5000);
      }
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!pluginId) {
        showMessage('Error: No plugin ID available. Please scan the QR code to access this form.', 'error');
        return;
      }

      // Check rate limiting before submission
      if (!checkRateLimit()) {
        showMessage('Please wait before sending another message.', 'warning');
        return;
      }

      const messageText = messageInput.value.trim();
      const authorText = authorInput.value.trim();
      const imageUrl = imageUrlInput.value.trim();

      // Check if at least one of message or image is provided
      if (!messageText && !imageUrl) {
        showMessage('Please enter either a message or an image URL.', 'error');
        return;
      }

      // If an image URL is provided, validate it again before submission
      if (imageUrl) {
        try {
          new URL(imageUrl);
        } catch (e) {
          showMessage('Please enter a valid image URL.', 'error');
          return;
        }
      }

      // Disable button during submission
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      // Build webhook URL - NO /webhook suffix!
      const webhookUrl = `https://usetrmnl.com/api/custom_plugins/${pluginId}`;

      // Get current UTC timestamp
      const timestampUtc = new Date().toISOString();

      const payload = {
        merge_variables: {
          message: messageText,
          image_url: imageUrl,
          author: authorText,
          timestamp_utc: timestampUtc
        }
      };

      console.log('Sending to:', webhookUrl);
      console.log('Payload:', payload);

      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        console.log('Response status:', response.status);

        if (response.ok) {
          showMessage('âœ“ Message sent successfully!', 'success');
          // Save submission timestamp for rate limiting
          saveLastSubmission();
          // Update rate limit UI
          checkRateLimit();

          // Clear form but keep author
          messageInput.value = '';
          imageUrlInput.value = '';
          charCount.textContent = '0';

          // Reset image preview and validation
          imageValidation.className = 'validation';
          imagePreview.className = 'image-preview';
          imagePreview.innerHTML = '';
        } else {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
      } catch (error) {
        console.error('Full error:', error);
        showMessage(`Failed to send message: ${error.message}`, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
      }
    });

    // Initialize the form when page loads
    document.addEventListener('DOMContentLoaded', initializeForm);
  </script>
</body>
</html>